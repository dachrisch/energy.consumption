# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json

name: ðŸ³ðŸ§ª Test Docker Image

on:
  workflow_call:
    inputs:
      artifact_name:
        required: true
        description: The name of the artifact containing the Docker image
        type: string
      image_name:
        required: true
        description: The local name of the Docker image
        type: string

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Download Docker image artifact
        uses: actions/download-artifact@v7
        with:
          name: ${{ inputs.artifact_name }}
          path: /tmp

      - name: ðŸ³ Load Docker image
        run: |
          docker load --input /tmp/${{ inputs.image_name }}.tar
          docker image ls -a

      - name: ðŸ³ðŸ§ª Test Docker image
        run: |
          docker run --rm --detach --name test_container ${{ inputs.image_name }}:latest
          for i in {1..10}; do
            # Check for Health status if available, fallback to State status
            status=$(docker inspect --format='{{if .State.Health}}{{.State.Health.Status}}{{else}}{{.State.Status}}{{end}}' test_container)
            echo "Container status: $status"
            
            if [ "$status" = "healthy" ] || [ "$status" = "running" ]; then
              # If we have a healthcheck, we wait for "healthy". 
              # If we don't have a healthcheck, "running" is as good as it gets here.
              # However, if we JUST started, "running" might be true while Nginx is still booting.
              # But usually Nginx is fast.
              
              if [ "$status" = "healthy" ]; then
                echo "Container is healthy!"
                break
              fi
              
              # If no health check defined, just check if it's running and maybe give it a second
              has_health=$(docker inspect --format='{{.State.Health}}' test_container 2>/dev/null || echo "none")
              if [ "$has_health" = "<nil>" ] || [ "$has_health" = "none" ] || [ -z "$has_health" ]; then
                echo "No health check defined, container is running."
                break
              fi
            fi

            if [ "$status" = "unhealthy" ]; then
              echo "Container became unhealthy."
              docker logs test_container
              docker inspect test_container
              exit 1
            fi
            
            echo "Waiting for container to be ready... (attempt $i)"
            sleep 6
          done
          
          # Final check
          final_status=$(docker inspect --format='{{if .State.Health}}{{.State.Health.Status}}{{else}}{{.State.Status}}{{end}}' test_container)
          if [ "$final_status" != "healthy" ] && [ "$final_status" != "running" ]; then
            echo "Container failed to start or become healthy. Status: $final_status"
            echo "Full inspect output:"
            docker inspect test_container
            echo "Container logs:"
            docker logs test_container
            exit 1
          fi
          docker stop test_container
